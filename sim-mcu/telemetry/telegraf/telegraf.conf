[agent]
  interval = "1s"
  flush_interval = "1s"
  omit_hostname = true

# Single MQTT input for both streams
[[inputs.mqtt_consumer]]
  servers            = ["tcp://mosquitto:1883"]
  topics             = ["sat/esp32s3/+/attitude","sat/esp32s3/+/rwheels"]
  qos                = 1
  persistent_session = false          # avoid session conflicts
  connection_timeout = "5s"
  data_format        = "json"
  name_override      = "telemetry"    # single measurement
  topic_tag          = "topic"        # capture full topic as a tag
  #json_time_key      = "ts"
  #json_time_format   = "unix_ms"
  json_timezone      = "UTC"

# Extract device_id and stream from topic: sat/esp32s3/<device_id>/<stream>
[[processors.regex]]
  order = 1
  [[processors.regex.tags]]
    key         = "topic"
    pattern     = "^sat/esp32s3/([^/]+)/([^/]+)$"
    replacement = "${1}"
    result_key  = "device_id"
  [[processors.regex.tags]]
    key         = "topic"
    pattern     = "^sat/esp32s3/([^/]+)/([^/]+)$"
    replacement = "${2}"
    result_key  = "stream"

# Convert types (safe if fields are missing)
[[processors.converter]]
  order = 2
  [processors.converter.fields]
    boolean = ["rw1_sat","rw2_sat","rw3_sat"]
    float   = ["q_w","q_x","q_y","q_z","w_x","w_y","w_z","rw1","rw2","rw3"]

# Write to InfluxDB v2
[[outputs.influxdb_v2]]
  urls         = ["http://influxdb:8086"]
  token        = "$INFLUX_TOKEN"
  organization = "telemetry"
  bucket       = "raw_7d"

